<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="spring.model.mapper.AdminMapper">
	<select id="total" parameterType="String" resultType="int">
		select count(b.state) 
		from norder a, orderItem b 
		where a.orderno = b.orderno  
		<choose>
			<when test= '_parameter.equals("신규주문")'>
			<![CDATA[
			and b.state = '배송준비' 
			and to_char(odate,'yyyyMMdd') >= to_char(sysdate-3,'yyyyMMdd')
			]]>
			</when>
			<otherwise>
			and b.state = #{state}
			</otherwise>
		</choose>
	</select>
	<select id="totalP" parameterType="map" resultType="int">
		select count(*) from 
			(
			select a.id, a.orderno, i.title, b.orderitemno, a.odate 
			from norder a, orderitem b, itemoption o, item i
			where a.orderno = b.orderno and b.itemOptionNo = o.itemOptionNo and i.itemNo = o.itemNo and b.state = #{state}
			)
		<where>
			<choose>
				<when test="col == 'onum'">
					and orderno like '%'||#{word}||'%'
				</when>
				<when test="col == 'otitle'">
					and title like '%'||#{word}||'%'
				</when>
				<when test="col == 'buyer'">
					and id like '%'||#{word}||'%'
				</when>
				<when test="col == 'odate'">
					and to_char(odate,'yyyy-MM-dd') like '%'||#{word}||'%'
				</when>
			</choose>
		</where>
	</select>
	
	<resultMap type="orderDTO" id="orderMap">
		<result property="id" column="id"/>
		<result property="orderNo" column="orderno"/>
		<result property="odate" column="odate"/>
		<collection property="orderItemList" column="orderno"
			javaType="List" ofType="OrderItemDTO" resultMap="orderItemDTOListMap" />
	</resultMap>
	<resultMap type="OrderItemDTO" id="orderItemDTOListMap">
		<result property="count" column="count"/>
		<result property="state" column="state"/>	
		<result property="itemNo" column="itemno"/>	
		<result property="itemPrice" column="itemPrice"/>	
		<result property="itemImage" column="itemImage"/>	
		<result property="itemTitle" column="itemTitle"/>	
		<result property="itemSize" column="itemSize"/>	
		<result property="itemColor" column="itemColor"/>	
		<result property="orderItemNo" column="orderItemNo"/>	
	</resultMap>
	
	<select id="list" parameterType="map" resultMap="orderMap">
		select * from
		(select orderno, id, odate, orderItemNo, count, state, itemPrice, itemTitle, itemSize, itemColor, itemImage, itemno, rownum r from
		(select b.orderItemNo orderItemNo, a.orderno orderno, a.id id, to_char(a.odate, 'yyyy-MM-dd') odate, b.count count,  b.state state, 
			b.itemPrice itemPrice, i.title itemTitle, o.itemSize itemSize, o.itemColor itemColor, i.image itemImage, i.itemno itemno
			from norder a, orderitem b ,item i, itemOption o
			where a.orderno = b.orderno and b.itemOptionNo = o.itemOptionNo and i.itemNo = o.itemNo 
			
				<choose>
					<when test="col == 'onum'">
						and a.orderno like '%'||#{word}||'%'
					</when>
					<when test="col == 'otitle'">
						and i.title like '%'||#{word}||'%'
					</when>
					<when test="col == 'buyer'">
						and a.id like '%'||#{word}||'%'
					</when>
					<when test="col == 'odate'">
						and to_char(a.odate,'yyyy-MM-dd') like '%'||#{word}||'%'
					</when>
				</choose>
				<choose>
					<when test= 'state.equals("신규주문")'>
					<![CDATA[
					and b.state = '배송준비' 
					and to_char(a.odate,'yyyyMMdd') >= to_char(sysdate-3,'yyyyMMdd')
					]]>
					</when>
					<otherwise>
					and b.state = #{state}
					</otherwise>
				</choose>
			order by a.orderno desc
			))
		<![CDATA[
		where r >=#{sno} and r<=#{eno}
		]]>
	</select>
	
	<select id="noticel" parameterType="int" resultType="NoticeDTO">
		select no, subject,lev, wdate from (
		select no, subject, lev, to_char(wdate, 'mm.dd.') wdate from notice order by no desc)
		<![CDATA[
		where lev = 'A' and rownum <=#{rownum}
		]]>
	</select>

	<select id="deliveryl" parameterType="int" resultType="BoardDTO">
		select board_no, subject, wdate from (
		select board_no, subject, to_char(wdate, 'mm.dd.') wdate, lev, type from board where indent = 0 order by board_no desc)
		<![CDATA[
		where rownum <=#{rownum} and type='기타'
		]]>
		and LEV = 'A'
	</select>

	<select id="communityl" parameterType="int" resultType="BoardDTO">
		select board_no, content, wdate from (
		select board_no, content, to_char(wdate, 'mm.dd.') wdate, type from board order by board_no desc)
		<![CDATA[
		where rownum <=#{rownum} and type='상품'
		]]>
	</select>
	
	<update id="updateState" parameterType="Map">
		update orderitem
		set state = #{state}
		<choose>
			<when test= 'state.equals("배송중")'>
			and deliveryno = #{deliveryno}
			</when>
		</choose>
		where orderno = #{orderno}
	</update>
	
	
	<select id="read" parameterType="String" resultType="MemberDTO">
		select * from member
		where id = #{id}
	</select>
	
	<resultMap type="orderDTO" id="orderReadMap">
		
		<result property="postcode" column="postcode"/>
		<result property="address" column="address"/>
		<result property="detailaddress" column="detailaddress"/>
		<result property="rmsg" column="rmsg"/>
		<result property="rphone" column="rphone"/>
		<result property="state" column="state"/>
		<result property="name" column="name"/>
		<result property="rname" column="rname"/>
		<result property="orderNo" column="orderNo"/>
		<result property="odate" column="odate"/>
		<result property="totalPrice" column="totalprice"/>
		<result property="salePrice" column="saleprice"/>
		<result property="paymentType" column="paymenttype"/>
		<collection property="orderItemList" column="orderno"
			javaType="List" ofType="OrderItemDTO" resultMap="orderItemDTOListReadMap" />
	</resultMap>
	<resultMap type="OrderItemDTO" id="orderItemDTOListReadMap">	
		<result property="itemPrice" column="itemprice"/>	
		<result property="orderItemNo" column="orderItemNo"/>	
	</resultMap>
	<select id="readP" parameterType="map" resultMap="orderReadMap">
	select distinct(orderno), odate, name, totalprice, saleprice, paymenttype, state, rname,
	postcode, address, detailaddress, rphone, rmsg	
	
	from(
		select b.orderitemno orderItemNo, a.orderno orderNo, a.odate odate, c.name name, a.rname rname,
			a.postcode postcode, a.address address, a.detailaddress detailaddress, a.rphone rphone, a.rmsg rmsg,
			b.itemprice itemprice, a.saleprice saleprice, a.paymenttype paymenttype, a.state state, 
			(select sum(itemprice) from orderitem where orderno = #{orderno}) totalprice
		from norder a, orderitem b, member c 
		where a.id = c.id and a.orderno = b.orderno and a.orderno = #{orderno})
	</select>
	
	<select id="readPList" parameterType="String" resultType="OrderItemDTO">
		select b.orderitemno orderItemNo, d.image itemImage, d.title itemTitle, d.itemno itemNo, 
			b.count count, b.itemprice itemPrice, b.state state
        from norder a, orderitem b, itemoption c, item d
        where a.orderno = b.orderno and b.itemoptionno = c.itemoptionno 
        and c.itemno = d.itemno and a.orderno = #{orderno}
	</select>
	
	<select id="orderCount" parameterType="String" resultType="OrderItemDTO">
		select i.state, count(*) as count
		from
		norder o, orderitem i
		where id = #{id} and o.orderno=i.orderno
		group by i.state
		order by i.state
	</select>
	
</mapper>